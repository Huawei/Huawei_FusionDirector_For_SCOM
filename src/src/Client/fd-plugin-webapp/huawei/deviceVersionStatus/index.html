<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>设备版本状态</title>
    <link href="../../css/element.css" rel="stylesheet" />
    <link href="../../css/style.css" rel="stylesheet" />
    <script src="../../scripts/vue.js"></script>
    <script src="../../scripts/element.js"></script>
    <script src="../../scripts/jquery-3.2.1.min.js"></script>
    <script src="../../scripts/i18n/zh-CN.js"></script>
    <script src="../../scripts/i18n/en.js"></script>
    <script src="../i18n/en.js"></script>
    <script src="../i18n/zh-CN.js"></script>
    <script src="../../scripts/polyfill.min.js"></script>
    <script src="../js/common.js"></script>
    <script src="../../scripts/web-platform.js"></script>
    <script src="../js/errorCode.js"></script>
    <script src="../../scripts/lodash.min.js"></script>
    <script src="js/rest.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        body {
            min-width: 900px;
        }

        /* 部署的下拉搜索框 */
        .input-with-select {
            display: inline-block;
            position: relative;
        }

        .input-with-select .el-select .el-input {
            width: 130px;
        }

        .demo-table-expand {
            font-size: 0;
        }

        .demo-table-expand label {
            width: 120px;
            color: #99a9bf;
        }

        .demo-table-expand .el-form-item {
            margin-right: 0;
            margin-bottom: 0;
            width: 50%;
        }

        .el-progress-bar {
            padding-right: 60px;
            margin-left: -20px;
        }

        .map-row {
            padding: 15px;
            background: #f6f7f8;
            margin: 15px 0;
        }

        .search-row .el-button {
            vertical-align: middle;
        }

        .search-row .el-input-group {
            vertical-align: middle;
        }
        .desLength{
            position: absolute;
            bottom: 0px;
            left: 340px;
            color: #999;
            width: 50px;
            text-align: right;
       }
       .moudle_table_header{
           display: none;
       }
       .row-expand-cover .el-table__expand-column .el-icon{
            visibility:hidden;
        }
        .hide-padding + tr .el-table__expanded-cell{
            padding: 0;
            padding-left: 48px;
            border: none;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <!-- 顶部操作栏 -->
        <el-row class="search-row">
            <el-dropdown @command="commandClick">
                <el-button>
                    {{menuName}}
                    <i class="el-icon-caret-bottom el-icon--right"></i>
                </el-button>
                <el-dropdown-menu slot="dropdown">
                    <el-dropdown-item v-for="item in FDs" v-bind:command="item.name" v-bind:key="item.name">{{item.label}}</el-dropdown-item>
                </el-dropdown-menu>
            </el-dropdown>
        </el-row>
        <div>
            <el-tabs v-model="activeType" @tab-click="handleClick">
                <!-- 服务器 -->
                <el-tab-pane :label="i18ns.common.server" name="first">
                    <div>
                        <el-row class="search-row">
                            <div class="input-with-select">
                                <el-input v-model.trim="keyword" clearable :placeholder="i18ns.deviceVersionStatus.deviceVersionStatus_SearchTip">
                                    <el-button slot="append" icon="el-icon-search" @click="searchScope"></el-button>
                                </el-input>
                            </div>
                            <el-button icon="plus" v-on:click="refreshTemplate()">{{i18ns.common.refresh}}</el-button>
                            <el-button icon="plus" v-on:click="takeAllEffect()" :disabled="checkedTake.length<=0">{{i18ns.deviceVersionStatus.deviceVersionStatus_effective}}</el-button>
                        </el-row>
                        <el-table v-bind:data="listData" border style="width:100%;" v-loading="loading"
                            :element-loading-text="i18ns.common.loading" header-row-class-name="my_table_header"
                            @selection-change="taskSelectionChange">
                            <el-table-column type="expand">
                                <template slot-scope="props">
                                    <el-table ref="ModuleInfo" :data="props.row.ModulesInfo" style="width: 100%;"
                                        header-row-class-name="my_table_header" :row-class-name="getClassName">
                                        <el-table-column type="expand">
                                            <template slot-scope="props">
                                                <el-table :data="props.row.Modules" style="width: 100%;" :show-header="false">
                                                    <el-table-column prop="ModuleName" :label="i18ns.deviceVersionStatus.deviceVersionStatus_firmwareType"></el-table-column>
                                                    <el-table-column prop="Status" :label="i18ns.deviceVersionStatus.deviceVersionStatus_status">
                                                        <template slot-scope="scope">
                                                            {{getStatusName(scope.row.Status)}}
                                                        </template>
                                                    </el-table-column>
                                                    <el-table-column prop="DeviceName" :label="i18ns.deviceVersionStatus.deviceVersionStatus_name"></el-table-column>
                                                    <el-table-column prop="Module" :label="i18ns.deviceVersionStatus.deviceVersionStatus_model"></el-table-column>
                                                    <el-table-column prop="Slot" :label="i18ns.deviceVersionStatus.deviceVersionStatus_slot"></el-table-column>
                                                    <el-table-column prop="CurrentVersion" :show-overflow-tooltip="true"
                                                        :label="i18ns.deviceVersionStatus.deviceVersionStatus_currentVersion"></el-table-column>
                                                    <el-table-column prop="TargetVersion" :label="i18ns.deviceVersionStatus.deviceVersionStatus_targetVersion"></el-table-column>
                                                    <el-table-column prop="CurrentDriverVersion" :label="i18ns.deviceVersionStatus.deviceVersionStatus_currentDriverVersion"></el-table-column>
                                                    <el-table-column prop="TargetDriverVersion" :label="i18ns.deviceVersionStatus.deviceVersionStatus_targetDriverVersion"></el-table-column>
                                                </el-table>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="ModuleName" :label="i18ns.deviceVersionStatus.deviceVersionStatus_firmwareType"></el-table-column>
                                        <el-table-column prop="Status" :label="i18ns.deviceVersionStatus.deviceVersionStatus_status">
                                            <template slot-scope="scope">
                                                {{getStatusName(scope.row.Status)}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :label="i18ns.deviceVersionStatus.deviceVersionStatus_name">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].DeviceName}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :label="i18ns.deviceVersionStatus.deviceVersionStatus_model">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].Module}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :label="i18ns.deviceVersionStatus.deviceVersionStatus_slot">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].Slot}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :show-overflow-tooltip="true" :label="i18ns.deviceVersionStatus.deviceVersionStatus_currentVersion">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].CurrentVersion}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :label="i18ns.deviceVersionStatus.deviceVersionStatus_targetVersion">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].TargetVersion}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :label="i18ns.deviceVersionStatus.deviceVersionStatus_currentDriverVersion">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].CurrentDriverVersion}}
                                            </template>
                                        </el-table-column>
                                        <el-table-column :label="i18ns.deviceVersionStatus.deviceVersionStatus_targetDriverVersion">
                                            <template slot-scope="scope">
                                                {{scope.row.Modules.length>1?"":scope.row.Modules[0].TargetDriverVersion}}
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </template>
                            </el-table-column>
                            <el-table-column type="selection" width="55" :selectable='checkboxT'></el-table-column>
                            <el-table-column prop="BMCIP" :label="i18ns.deviceVersionStatus.deviceVersionStatus_BMCIP"></el-table-column>
                            <el-table-column prop="SerialNumber" :show-overflow-tooltip="true" :label="i18ns.deviceVersionStatus.deviceVersionStatus_serialNumber"></el-table-column>
                            <el-table-column prop="Status" :label="i18ns.deviceVersionStatus.deviceVersionStatus_status"
                                sortable>
                                <template slot-scope="scope">
                                    {{getStatusName(scope.row.Status)}}
                                </template>
                            </el-table-column>
                            <el-table-column prop="PorductType" :label="i18ns.deviceVersionStatus.deviceVersionStatus_productType"></el-table-column>
                            <el-table-column prop="BaselineOrPackageName" :show-overflow-tooltip="true" :label="i18ns.deviceVersionStatus.deviceVersionStatus_baselineUpgradePackage"
                                sortable></el-table-column>
                            <el-table-column prop="PlanName" :label="i18ns.deviceVersionStatus.deviceVersionStatus_plan"
                                sortable></el-table-column>
                            <el-table-column prop="SpecifiedTime" :label="i18ns.deviceVersionStatus.deviceVersionStatus_upgradeTime"></el-table-column>
                            <el-table-column :label="i18ns.common.operation">
                                <template slot-scope="scope">
                                    <el-button type="text" size="small" :disabled="scope.row.Status!='ToTakeEffect'"
                                        @click="takeEffect(scope.row)">{{i18ns.deviceVersionStatus.deviceVersionStatus_effective}}</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <el-row class="pagination-row">
                            <el-col v-bind:span="24" style="text-align:right;">
                                {{i18ns.common.common_totalNumber}}{{listData.length}}
                            </el-col>
                        </el-row>
                    </div>

                </el-tab-pane>
                <!-- 机框 -->
                <el-tab-pane :label="i18ns.deviceVersionStatus.deviceVersionStatus_Chassis" name="second" :disabled="true">
                    <div>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>
        <!-- 生效弹窗 -->
        <el-dialog :title="i18ns.common.warn" :visible.sync="takeDialogisible" width="60%">
            <el-row>
                <el-alert :title="i18ns.deviceVersionStatus.deviceVersionStatus_autoDiscoveryDeleteTip" type="info"
                    :description="i18ns.deviceVersionStatus.deviceVersionStatus_autoDiscoveryDeleteMsg" show-icon
                    :closable="false">
                </el-alert>
            </el-row>
            <el-table :data="takeEffectList" border style="width: 100%; margin-top: 10px;" header-row-class-name="my_table_header">
                <el-table-column prop="BMCIP" :label="i18ns.deviceVersionStatus.deviceVersionStatus_BMCIP"></el-table-column>
                <el-table-column prop="SerialNumber" :show-overflow-tooltip="true" :label="i18ns.deviceVersionStatus.deviceVersionStatus_serialNumber"></el-table-column>
                <el-table-column prop="Status" :label="i18ns.deviceVersionStatus.deviceVersionStatus_status" sortable>
                    <template slot-scope="scope">
                        {{getStatusName(scope.row.Status)}}
                    </template>
                </el-table-column>
                <el-table-column prop="PlanName" :label="i18ns.deviceVersionStatus.deviceVersionStatus_plan" sortable></el-table-column>
            </el-table>
            <div slot="footer" class="dialog-footer">
                <el-button @click="takeDialogisible=false">{{i18ns.common.no}}</el-button>
                <el-button @click="takeSubmit" v-loading.fullscreen.lock="fullscreenLoading" :element-loading-text="i18ns.common.loading"
                    type="primary">{{i18ns.common.yes}}</el-button>
            </div>
        </el-dialog>
    </div>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                i18ns: [],
                FDs: [],
                FDIp: '',
                menuName: '',
                menuKey: '',
                listData: [],
                profileId: '', //配置ID
                /*显示表格数据加载中*/
                loading: false,
                /*删除操作遮罩*/
                fullscreenLoading: false,
                currentPage: 1,
                pageSizes:  [20, 35, 50, 100],
                pageSize: 10,
                total: 0,
                multipleSelection: [],

                deviceListSelection: [],
                tipsDialogisible: false,

                deleteList: [], //要删除的数据
                keyword: '',
                activeType: 'first',
                //生效弹窗
                takeDialogisible: false,
                takeEffectList: [],
                checkedTake: []

            },
            created: function () {
                this.i18ns = getIn18();
                var _pageSize = localStorage.getItem("baselineListPageSize");
                if (_pageSize) {
                    this.pageSize = parseInt(_pageSize);
                };
            },
            mounted: function () {
                var that = this;
                //获取FD列表数据
                setTimeout(function () {
                    getFDList(that.bindFD);
                }, 0);
            },
            methods: {
                /**
                 * 国际化状态
                 */
                getStatusName: function (status) {
                    switch (status) {
                        case 'ToBeUpgraded':
                            return this.i18ns.deviceVersionStatus.deviceVersionStatus_toBeUpgraded;
                        case 'ToTakeEffect':
                            return this.i18ns.deviceVersionStatus.deviceVersionStatus_toTakeEffect;
                        case 'TakingEffect':
                            return this.i18ns.deviceVersionStatus.deviceVersionStatus_takingEffect;
                        case 'Effective':
                            return this.i18ns.deviceVersionStatus.deviceVersionStatus_effectived;
                        case 'Upgrading':
                            return this.i18ns.deviceVersionStatus.deviceVersionStatus_Upgrading;
                        case '':
                            return ' ';
                        case undefined:
                            return ' ';
                        default:
                            return '';
                    }
                },
                /**
                 * 获取FD数据 回调函数
                 * 
                 * @param {any} ret 
                 */
                bindFD: function (ret) {
                    if (ret.code === '0') {
                        var lg = ret.data.length;
                        if (lg > 0) {
                            for (var i = 0; i <
                                lg; i++) {
                                if (ret.data[i].aliasName) {
                                    this.FDs.push({
                                        label: ret.data[i].aliasName,
                                        name: ret.data[i].hostIp
                                    });
                                } else {
                                    this.FDs.push({
                                        label: ret.data[i].hostIp,
                                        name: ret.data[i].hostIp
                                    });
                                }
                            }
                            var currentFD = getCurrentFD();
                            if (currentFD) {
                                var _currentFD = _.find(this.FDs, {
                                    name: currentFD
                                })
                                if (_currentFD) {
                                    this.FDIp = currentFD;
                                    this.menuName = _currentFD.label; /*设置选项卡下拉框默认选中项*/
                                    this.menuKey = _currentFD.name; /*设置选项卡下拉框默认选中项*/
                                } else {
                                    setCurrentFD(ret.data[0].hostIp);
                                    this.FDIp = ret.data[0].hostIp;
                                    this.menuName = this.FDs[0].label; /*设置选项卡下拉框默认选中项*/
                                    this.menuKey = this.FDs[0].name; /*设置选项卡下拉框默认选中项*/
                                }
                            } else {
                                setCurrentFD(ret.data[0].hostIp);
                                this.FDIp = ret.data[0].hostIp;
                                this.menuName = this.FDs[0].label; /*设置选项卡下拉框默认选中项*/
                                this.menuKey = this.FDs[0].name; /*设置选项卡下拉框默认选中项*/
                            }
                            this.loading = true;
                            this.getListData(); /*获取列表数据*/
                        } else {
                            alertMsg(getErrorMsg({
                                code: '-90002'
                            }))
                        }
                    } else {
                        var msg = getErrorMsg(ret);
                        alertMsg(msg);
                    }
                },

                /**
                 * FD下拉框 点击切换事件
                 * 
                 * @param {any} command 
                 * @param {any} com 
                 */
                commandClick: function (command, com) {
                    this.menuName = com.$el.innerText;
                    this.menuKey = command;
                    this.FDIp = command;
                    setCurrentFD(command);
                    this.currentPage = 1;
                    this.pageSize = 20;
                    this.total = 0;
                    this.getListData();
                },

                /**
                 * 切换 服务器 机框
                 */
                handleClick: function () {
                    if (this.activeType == "first") {
                        this.getListData()
                    } else {
                        // this.getPackageListData();
                    }
                },

                /**
                 * 搜索服务器列表
                 */
                searchScope: function () {
                    this.getListData();
                },
                /**
                 * 获取服务器的列表
                 */
                getListData: function () {
                    this.listData = [];
                    upgradePackageManage.getScopesList({
                        ip: this.FDIp,
                        filter: this.keyword
                    }, this.bindList);
                },
                /**
                 * 获取服务器列表数据 回调函数
                 * 
                 * @param {any} ret 
                 */
                bindList: function (ret) {
                    if (ret.code === '0') {
                        this.listData = ret.data[0].data.Devices ? ret.data[0].data.Devices : [];
                    } else {
                        var msg = getErrorMsg(ret);
                        alertMsg(msg);
                    }
                    app.loading = false; /*隐藏loading提示*/
                },
                /**
                 * 刷新服务器列表
                 */
                refreshTemplate: function () {
                    this.loading = true;
                    this.getListData()
                },
                /**
                 * 禁用服务器的复选框
                 */
                checkboxT: function (row, index) {
                    if (row.Status !== 'ToTakeEffect') {
                        return 0;
                    } else {
                        return 1;
                    }
                },
                /**
                 * 隐藏展开图标
                 */
                getClassName: function (row, expandedRows) {
                    var res = [];
                    if (row.row.Modules && row.row.Modules.length == 1) {
                        res.push('row-expand-cover')
                    } else {
                        res.push('hide-padding')
                    }
                    return res.join(' ')
                },

                /**
                 * 服务器的全选
                 */
                taskSelectionChange: function (val) {
                    this.checkedTake = val;
                },
                /**
                 * 单个生效
                 */
                takeEffect: function (row) {
                    this.takeEffectList = []
                    this.takeDialogisible = true;
                    this.takeEffectList = [row];
                },
                /**
                 * 多个生效
                 */
                takeAllEffect: function (row) {
                    this.takeEffectList = []
                    this.takeDialogisible = true;
                    this.takeEffectList = this.checkedTake;
                },
                /**
                 * 确认生效
                 */
                takeSubmit: function () {
                    var param = {
                        Devices: []
                    }
                    for (var i = 0; i < _.size(this.takeEffectList); i++) {
                        console.log(this.takeEffectList[i])
                        param.Devices.push(this.takeEffectList[i].ID)
                    }
                    upgradePackageManage.ActiveFireware({
                        ip: app.FDIp,
                        data: param
                    }, function (res) {
                        if (res.code == 0) {
                            this.getListData();
                            _.each(res.data[0].data.TaskIDs, function (item) {
                                app.task(item);
                            })
                            app.takeDialogisible = false;
                        } else {
                            var msg = getErrorMsg(res);
                            alertMsg(msg);
                        }
                    });
                },
                /**
                 * 任务
                 */
                task: function (taskId) {
                    var mysetInterval = setInterval(function () {
                        upgradePackageManage.getMasterTaskInfo({
                            ip: app.FDIp,
                            id: taskId
                        }, function (res) {
                            if (res.code == 0) {
                                if (res.data[0].data.Status == 'Finish') {
                                    window.clearInterval(mysetInterval);
                                    this.getListData()
                                }
                            }
                            if (res.data[0].data.Status == 'Failed') {
                                window.clearInterval(mysetInterval);
                            }
                        });
                    }, 1000);
                },


                /**
                 * 获取机框
                 */
                getEnclosureDevicesData: function () {

                },
                /**
                 * 刷新机框
                 */
                refreshEnclosureDevices: function () {
                    this.getEnclosureDevicesData()
                },
                /**
                 * 选择机框
                 */
                uploadSelectionChange: function () {

                },

            }
        });
    </script>
</body>

</html>